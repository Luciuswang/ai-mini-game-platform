<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å¤šäººè´ªåƒè›‡ç«æŠ€ - AIæ¸¸æˆå¹³å°</title>
    
    <!-- å­—ä½“å’Œå›¾æ ‡ -->
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700;800;900&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Socket.IOå®¢æˆ·ç«¯ -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* ç”µç«é£æ ¼é…è‰² */
            --bg-primary: #0a0a0f;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --accent-primary: #00ff88;
            --accent-secondary: #ff6b9d;
            --accent-tertiary: #4fc3f7;
            --text-primary: #ffffff;
            --text-secondary: #b0b3c7;
            --warning: #ff9500;
            --danger: #ff5555;
            --success: #00ff88;
            
            /* è›‡çš„é¢œè‰² */
            --snake-player1: #00ff88;
            --snake-player2: #ff6b9d;
            --snake-player3: #4fc3f7;
            --snake-player4: #ffd93d;
            
            /* ç‰¹æ•ˆ */
            --glow-primary: 0 0 20px var(--accent-primary);
            --glow-secondary: 0 0 20px var(--accent-secondary);
            --shadow-deep: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        body {
            font-family: 'Exo 2', sans-serif;
            background: radial-gradient(ellipse at center, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
            overflow: hidden;
        }

        /* èƒŒæ™¯åŠ¨æ•ˆ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(0, 255, 136, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 107, 157, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(79, 195, 247, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .game-container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary));
            border-radius: 25px;
            border: 2px solid rgba(0, 255, 136, 0.3);
            box-shadow: var(--shadow-deep), var(--glow-primary);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .game-header {
            padding: 20px 30px;
            background: linear-gradient(90deg, var(--bg-primary), var(--bg-secondary));
            border-bottom: 2px solid rgba(0, 255, 136, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .game-title {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-tertiary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: var(--glow-primary);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger);
            box-shadow: 0 0 10px currentColor;
            transition: all 0.3s ease;
        }

        .status-indicator.connected {
            background: var(--success);
        }

        .game-content {
            flex: 1;
            display: flex;
            gap: 20px;
            padding: 20px;
        }

        .sidebar {
            width: 280px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .room-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .room-info {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .room-id {
            font-family: 'Orbitron', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }

        .room-players {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .players-list {
            margin-top: 15px;
        }

        .player-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border-left: 4px solid var(--accent-primary);
            transition: all 0.3s ease;
        }

        .player-item.player-2 { border-left-color: var(--snake-player2); }
        .player-item.player-3 { border-left-color: var(--snake-player3); }
        .player-item.player-4 { border-left-color: var(--snake-player4); }

        .player-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-tertiary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
        }

        .player-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .player-score {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-btn {
            background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary));
            color: var(--text-primary);
            border: 1px solid rgba(0, 255, 136, 0.3);
            padding: 12px 20px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-tertiary));
            transition: left 0.3s ease;
            z-index: -1;
        }

        .control-btn:hover::before {
            left: 0;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-primary);
            border-color: var(--accent-primary);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-btn:disabled:hover::before {
            left: -100%;
        }

        .control-btn.primary {
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-tertiary));
            border-color: var(--accent-primary);
            box-shadow: var(--glow-primary);
        }

        .control-btn.danger {
            background: linear-gradient(45deg, var(--danger), #cc4444);
            border-color: var(--danger);
            box-shadow: 0 0 20px var(--danger);
        }

        .game-canvas-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            padding: 20px;
            border: 2px solid rgba(0, 255, 136, 0.3);
            box-shadow: inset 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        #gameCanvas {
            border-radius: 15px;
            background: linear-gradient(145deg, #0a0a0f, #1a1a2e);
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .game-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .hud-item {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 10px 15px;
            backdrop-filter: blur(10px);
        }

        .hud-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .hud-value {
            font-family: 'Orbitron', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            z-index: 100;
        }

        .countdown-number {
            font-family: 'Orbitron', monospace;
            font-size: 8rem;
            font-weight: 900;
            color: var(--accent-primary);
            text-shadow: var(--glow-primary);
            animation: countdownPulse 1s ease-in-out;
        }

        .game-finished-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }

        .game-finished-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .finish-title {
            font-family: 'Orbitron', monospace;
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 20px;
            background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .finish-message {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
            text-align: center;
        }

        .leaderboard {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-width: 300px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            width: 30px;
        }

        .rank.first { color: #ffd700; }
        .rank.second { color: #c0c0c0; }
        .rank.third { color: #cd7f32; }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(145deg, var(--bg-tertiary), var(--bg-secondary));
            color: var(--text-secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            z-index: 10;
        }

        .back-btn:hover {
            background: linear-gradient(145deg, var(--accent-primary), var(--accent-tertiary));
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--glow-primary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        /* ç­‰å¾…ç•Œé¢ */
        .waiting-screen {
            text-align: center;
            padding: 40px;
        }

        .waiting-title {
            font-family: 'Orbitron', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 20px;
        }

        .waiting-message {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        /* åŠ¨ç”» */
        @keyframes countdownPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .game-container {
                height: 100vh;
                border-radius: 0;
                margin: 0;
            }

            .game-content {
                flex-direction: column;
                padding: 10px;
            }

            .sidebar {
                width: 100%;
                margin-bottom: 20px;
            }

            .game-title {
                font-size: 1.5rem;
            }

            .countdown-number {
                font-size: 4rem;
            }

            .game-hud {
                flex-direction: column;
                gap: 10px;
                top: 10px;
                left: 10px;
                right: auto;
            }
        }

        /* ç‰¹æ®ŠçŠ¶æ€ */
        .hidden {
            display: none !important;
        }

        .game-area.waiting {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <a href="../../index.html" class="back-btn" title="è¿”å›ä¸»é¡µ">
            <i class="fas fa-arrow-left"></i>
        </a>

        <div class="game-header">
            <h1 class="game-title">ğŸ å¤šäººè´ªåƒè›‡ç«æŠ€</h1>
            <div class="connection-status">
                <div class="status-indicator" id="connectionIndicator"></div>
                <span id="connectionText">è¿æ¥ä¸­...</span>
            </div>
        </div>

        <div class="game-content">
            <div class="sidebar">
                <!-- æˆ¿é—´ä¿¡æ¯ -->
                <div class="room-section">
                    <div class="section-title">
                        <i class="fas fa-home"></i>
                        æˆ¿é—´ä¿¡æ¯
                    </div>
                    <div class="room-info" id="roomInfo">
                        <div class="room-id">ç­‰å¾…è¿æ¥...</div>
                        <div class="room-players">ç©å®¶: 0/4</div>
                    </div>
                </div>

                <!-- ç©å®¶åˆ—è¡¨ -->
                <div class="room-section">
                    <div class="section-title">
                        <i class="fas fa-users"></i>
                        ç©å®¶åˆ—è¡¨
                    </div>
                    <div class="players-list" id="playersList">
                        <!-- ç©å®¶åŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>

                <!-- æ¸¸æˆæ§åˆ¶ -->
                <div class="room-section">
                    <div class="section-title">
                        <i class="fas fa-gamepad"></i>
                        æ¸¸æˆæ§åˆ¶
                    </div>
                    <div class="game-controls">
                        <button class="control-btn primary" id="joinRoomBtn" onclick="joinRandomRoom()">
                            <i class="fas fa-play"></i> å¿«é€ŸåŒ¹é…
                        </button>
                        <button class="control-btn" id="readyBtn" onclick="toggleReady()" disabled>
                            <i class="fas fa-check"></i> å‡†å¤‡å°±ç»ª
                        </button>
                        <button class="control-btn danger" id="leaveRoomBtn" onclick="leaveRoom()" disabled>
                            <i class="fas fa-sign-out-alt"></i> ç¦»å¼€æˆ¿é—´
                        </button>
                    </div>
                </div>

                <!-- æ¸¸æˆè§„åˆ™ -->
                <div class="room-section">
                    <div class="section-title">
                        <i class="fas fa-info-circle"></i>
                        ç«é€Ÿè§„åˆ™
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">
                        <p>ğŸ¯ <strong>ç›®æ ‡</strong>: æœ€å¿«è¾¾åˆ°100åˆ†è·èƒœ</p>
                        <p>ğŸƒ <strong>æ¨¡å¼</strong>: 2-4äººåŒæ—¶ç«æŠ€</p>
                        <p>âŒ¨ï¸ <strong>æ“ä½œ</strong>: æ–¹å‘é”®/WASDæ§åˆ¶</p>
                        <p>ğŸ <strong>å¾—åˆ†</strong>: åƒé£Ÿç‰©+10åˆ†ï¼Œé•¿åº¦+1</p>
                        <p>ğŸ’€ <strong>æ·˜æ±°</strong>: æ’å¢™æˆ–æ’è‡ªå·±å‡ºå±€</p>
                    </div>
                </div>
            </div>

            <div class="game-area" id="gameArea">
                <!-- ç­‰å¾…ç•Œé¢ -->
                <div class="waiting-screen" id="waitingScreen">
                    <div class="waiting-title">ğŸ® å‡†å¤‡ç«æŠ€</div>
                    <div class="waiting-message">
                        ç‚¹å‡»"å¿«é€ŸåŒ¹é…"å¼€å§‹å¯»æ‰¾å¯¹æ‰‹<br>
                        æˆ–åˆ›å»ºæˆ¿é—´é‚€è¯·å¥½å‹ä¸€èµ·æ¸¸æˆ
                    </div>
                    <div class="loading-spinner hidden" id="loadingSpinner"></div>
                </div>

                <!-- æ¸¸æˆç”»å¸ƒå®¹å™¨ -->
                <div class="game-canvas-container hidden" id="canvasContainer">
                    <canvas id="gameCanvas" width="600" height="600"></canvas>
                    
                    <!-- æ¸¸æˆHUD -->
                    <div class="game-hud">
                        <div class="hud-item">
                            <div class="hud-label">æˆ‘çš„åˆ†æ•°</div>
                            <div class="hud-value" id="myScore">0</div>
                        </div>
                        <div class="hud-item">
                            <div class="hud-label">ç›®æ ‡åˆ†æ•°</div>
                            <div class="hud-value">100</div>
                        </div>
                        <div class="hud-item">
                            <div class="hud-label">æ¸¸æˆæ—¶é—´</div>
                            <div class="hud-value" id="gameTime">00:00</div>
                        </div>
                    </div>

                    <!-- å€’è®¡æ—¶è¦†ç›–å±‚ -->
                    <div class="countdown-overlay hidden" id="countdownOverlay">
                        <div class="countdown-number" id="countdownNumber">3</div>
                    </div>

                    <!-- æ¸¸æˆç»“æŸè¦†ç›–å±‚ -->
                    <div class="game-finished-overlay" id="gameFinishedOverlay">
                        <h2 class="finish-title" id="finishTitle">æ¸¸æˆç»“æŸ</h2>
                        <p class="finish-message" id="finishMessage">æ¯”èµ›å·²ç»“æŸ</p>
                        
                        <div class="leaderboard" id="finalLeaderboard">
                            <!-- æœ€ç»ˆæ’è¡Œæ¦œ -->
                        </div>

                        <button class="control-btn primary" onclick="joinRandomRoom()">
                            <i class="fas fa-redo"></i> å†æ¥ä¸€å±€
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MultiplayerSnakeGame {
            constructor() {
                this.socket = null;
                this.connected = false;
                this.playerInfo = null;
                this.roomInfo = null;
                this.gameState = 'waiting'; // waiting, ready, countdown, playing, finished
                this.localSnake = null;
                this.otherPlayers = new Map();
                this.food = null;
                this.gameStartTime = null;
                this.targetScore = 100;
                
                // Canvasè®¾ç½®
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.gridSize = 20;
                this.tileCount = this.canvas.width / this.gridSize;
                
                // æ§åˆ¶
                this.inputQueue = [];
                this.lastDirection = { x: 1, y: 0 };
                
                // UIå…ƒç´ 
                this.connectionIndicator = document.getElementById('connectionIndicator');
                this.connectionText = document.getElementById('connectionText');
                this.roomInfo = document.getElementById('roomInfo');
                this.playersList = document.getElementById('playersList');
                this.waitingScreen = document.getElementById('waitingScreen');
                this.canvasContainer = document.getElementById('canvasContainer');
                this.loadingSpinner = document.getElementById('loadingSpinner');
                this.countdownOverlay = document.getElementById('countdownOverlay');
                this.gameFinishedOverlay = document.getElementById('gameFinishedOverlay');
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.connectToServer();
                console.log('ğŸ® å¤šäººè´ªåƒè›‡æ¸¸æˆåˆå§‹åŒ–å®Œæˆ');
            }

            setupEventListeners() {
                // é”®ç›˜æ§åˆ¶
                document.addEventListener('keydown', (e) => {
                    if (this.gameState !== 'playing') return;
                    
                    let direction = null;
                    switch (e.key) {
                        case 'ArrowUp':
                        case 'w':
                        case 'W':
                            direction = { x: 0, y: -1 };
                            break;
                        case 'ArrowDown':
                        case 's':
                        case 'S':
                            direction = { x: 0, y: 1 };
                            break;
                        case 'ArrowLeft':
                        case 'a':
                        case 'A':
                            direction = { x: -1, y: 0 };
                            break;
                        case 'ArrowRight':
                        case 'd':
                        case 'D':
                            direction = { x: 1, y: 0 };
                            break;
                    }
                    
                    if (direction && this.isValidDirection(direction)) {
                        this.inputQueue.push(direction);
                        e.preventDefault();
                    }
                });

                // è§¦æ‘¸æ§åˆ¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                let touchStartX, touchStartY;
                this.canvas.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    touchStartX = touch.clientX;
                    touchStartY = touch.clientY;
                    e.preventDefault();
                });

                this.canvas.addEventListener('touchend', (e) => {
                    if (!touchStartX || !touchStartY) return;
                    
                    const touch = e.changedTouches[0];
                    const deltaX = touch.clientX - touchStartX;
                    const deltaY = touch.clientY - touchStartY;
                    
                    const minSwipeDistance = 30;
                    const absX = Math.abs(deltaX);
                    const absY = Math.abs(deltaY);
                    
                    let direction = null;
                    if (Math.max(absX, absY) > minSwipeDistance) {
                        if (absX > absY) {
                            direction = deltaX > 0 ? { x: 1, y: 0 } : { x: -1, y: 0 };
                        } else {
                            direction = deltaY > 0 ? { x: 0, y: 1 } : { x: 0, y: -1 };
                        }
                    }
                    
                    if (direction && this.isValidDirection(direction)) {
                        this.inputQueue.push(direction);
                    }
                    
                    e.preventDefault();
                });
            }

            isValidDirection(newDirection) {
                if (!this.localSnake || this.localSnake.body.length <= 1) return true;
                
                // ä¸èƒ½åå‘ç§»åŠ¨
                return !(newDirection.x === -this.lastDirection.x && newDirection.y === -this.lastDirection.y);
            }

            connectToServer() {
                try {
                    this.socket = io('http://localhost:5000');
                    
                    this.socket.on('connect', () => {
                        this.connected = true;
                        this.updateConnectionStatus(true);
                        this.authenticateUser();
                    });

                    this.socket.on('disconnect', () => {
                        this.connected = false;
                        this.updateConnectionStatus(false);
                    });

                    this.socket.on('connect_error', (error) => {
                        console.error('è¿æ¥é”™è¯¯:', error);
                        this.updateConnectionStatus(false);
                    });

                    // æ¸¸æˆç›¸å…³äº‹ä»¶
                    this.setupGameEvents();
                    
                } catch (error) {
                    console.error('WebSocketè¿æ¥å¤±è´¥:', error);
                    this.updateConnectionStatus(false);
                }
            }

            setupGameEvents() {
                // æˆ¿é—´ç›¸å…³äº‹ä»¶
                this.socket.on('room_joined', (data) => {
                    this.roomInfo = data.room;
                    this.playerInfo = data.player;
                    this.updateRoomDisplay();
                    this.updateButtonStates();
                });

                this.socket.on('room_updated', (data) => {
                    this.roomInfo = data.room;
                    this.updateRoomDisplay();
                });

                this.socket.on('player_joined', (data) => {
                    this.updateRoomDisplay();
                    this.showNotification(`${data.player.username} åŠ å…¥äº†æˆ¿é—´`);
                });

                this.socket.on('player_left', (data) => {
                    this.updateRoomDisplay();
                    this.showNotification(`${data.player.username} ç¦»å¼€äº†æˆ¿é—´`);
                });

                // æ¸¸æˆäº‹ä»¶
                this.socket.on('game_countdown', (data) => {
                    this.startCountdown(data.count);
                });

                this.socket.on('game_started', (data) => {
                    this.startGame(data);
                });

                this.socket.on('game_state_update', (data) => {
                    this.updateGameState(data);
                });

                this.socket.on('game_finished', (data) => {
                    this.finishGame(data);
                });

                this.socket.on('player_eliminated', (data) => {
                    this.eliminatePlayer(data);
                });

                // é”™è¯¯å¤„ç†
                this.socket.on('error', (data) => {
                    this.showNotification(data.message, 'error');
                });
            }

            authenticateUser() {
                const userData = {
                    userId: `player_${Date.now()}`,
                    username: `ç©å®¶${Math.floor(Math.random() * 1000)}`
                };
                
                this.socket.emit('user_online', userData);
            }

            updateConnectionStatus(connected) {
                this.connected = connected;
                this.connectionIndicator.classList.toggle('connected', connected);
                this.connectionText.textContent = connected ? 'å·²è¿æ¥' : 'è¿æ¥ä¸­...';
            }

            updateRoomDisplay() {
                if (!this.roomInfo) {
                    this.roomInfo.innerHTML = `
                        <div class="room-id">ç­‰å¾…è¿æ¥...</div>
                        <div class="room-players">ç©å®¶: 0/4</div>
                    `;
                    this.playersList.innerHTML = '';
                    return;
                }

                // æ›´æ–°æˆ¿é—´ä¿¡æ¯
                document.querySelector('.room-id').textContent = `æˆ¿é—´ ${this.roomInfo.id.slice(-6)}`;
                document.querySelector('.room-players').textContent = 
                    `ç©å®¶: ${this.roomInfo.players.length}/4`;

                // æ›´æ–°ç©å®¶åˆ—è¡¨
                this.playersList.innerHTML = '';
                this.roomInfo.players.forEach((player, index) => {
                    const playerElement = document.createElement('div');
                    playerElement.className = `player-item player-${index + 1}`;
                    
                    const isMe = player.id === this.playerInfo?.id;
                    const readyStatus = player.ready ? 'âœ…' : 'â³';
                    
                    playerElement.innerHTML = `
                        <div class="player-info">
                            <div class="player-avatar">${player.username.charAt(0)}</div>
                            <div class="player-name">${player.username}${isMe ? ' (æˆ‘)' : ''}</div>
                        </div>
                        <div class="player-score">${readyStatus}</div>
                    `;
                    
                    this.playersList.appendChild(playerElement);
                });
            }

            updateButtonStates() {
                const joinBtn = document.getElementById('joinRoomBtn');
                const readyBtn = document.getElementById('readyBtn');
                const leaveBtn = document.getElementById('leaveRoomBtn');

                if (this.roomInfo) {
                    joinBtn.style.display = 'none';
                    readyBtn.disabled = false;
                    leaveBtn.disabled = false;
                    
                    const myPlayer = this.roomInfo.players.find(p => p.id === this.playerInfo?.id);
                    if (myPlayer) {
                        readyBtn.innerHTML = myPlayer.ready ? 
                            '<i class="fas fa-times"></i> å–æ¶ˆå‡†å¤‡' : 
                            '<i class="fas fa-check"></i> å‡†å¤‡å°±ç»ª';
                    }
                } else {
                    joinBtn.style.display = 'flex';
                    readyBtn.disabled = true;
                    leaveBtn.disabled = true;
                }
            }

            startCountdown(count) {
                this.gameState = 'countdown';
                this.showGameArea();
                
                this.countdownOverlay.classList.remove('hidden');
                this.updateCountdownDisplay(count);
                
                if (count > 0) {
                    setTimeout(() => {
                        this.startCountdown(count - 1);
                    }, 1000);
                } else {
                    setTimeout(() => {
                        this.countdownOverlay.classList.add('hidden');
                    }, 500);
                }
            }

            updateCountdownDisplay(count) {
                const countdownNumber = document.getElementById('countdownNumber');
                if (count > 0) {
                    countdownNumber.textContent = count;
                    countdownNumber.style.animation = 'none';
                    setTimeout(() => {
                        countdownNumber.style.animation = 'countdownPulse 1s ease-in-out';
                    }, 10);
                } else {
                    countdownNumber.textContent = 'GO!';
                    countdownNumber.style.color = 'var(--success)';
                }
            }

            startGame(gameData) {
                this.gameState = 'playing';
                this.gameStartTime = Date.now();
                this.localSnake = gameData.players.find(p => p.id === this.playerInfo.id);
                this.food = gameData.food;
                
                // åˆå§‹åŒ–å…¶ä»–ç©å®¶
                this.otherPlayers.clear();
                gameData.players.forEach(player => {
                    if (player.id !== this.playerInfo.id) {
                        this.otherPlayers.set(player.id, player);
                    }
                });
                
                this.startGameLoop();
                this.showNotification('æ¸¸æˆå¼€å§‹ï¼', 'success');
            }

            startGameLoop() {
                const gameLoop = () => {
                    if (this.gameState === 'playing') {
                        this.processInput();
                        this.updateGameTime();
                        this.render();
                        requestAnimationFrame(gameLoop);
                    }
                };
                gameLoop();
            }

            processInput() {
                if (this.inputQueue.length > 0) {
                    const direction = this.inputQueue.shift();
                    this.lastDirection = direction;
                    
                    // å‘é€ç§»åŠ¨æŒ‡ä»¤åˆ°æœåŠ¡å™¨
                    this.socket.emit('player_move', {
                        direction: direction,
                        timestamp: Date.now()
                    });
                }
            }

            updateGameState(data) {
                if (this.gameState !== 'playing') return;

                // æ›´æ–°æœ¬åœ°è›‡çš„çŠ¶æ€
                if (data.player && data.player.id === this.playerInfo.id) {
                    this.localSnake = data.player;
                    document.getElementById('myScore').textContent = this.localSnake.score;
                }

                // æ›´æ–°å…¶ä»–ç©å®¶
                if (data.otherPlayers) {
                    data.otherPlayers.forEach(player => {
                        this.otherPlayers.set(player.id, player);
                    });
                }

                // æ›´æ–°é£Ÿç‰©
                if (data.food) {
                    this.food = data.food;
                }

                // æ›´æ–°ç©å®¶åˆ—è¡¨ä¸­çš„åˆ†æ•°
                this.updatePlayersScore();
            }

            updatePlayersScore() {
                const playerItems = document.querySelectorAll('.player-item');
                playerItems.forEach((item, index) => {
                    const scoreElement = item.querySelector('.player-score');
                    const playerId = this.roomInfo.players[index]?.id;
                    
                    if (playerId === this.playerInfo.id) {
                        scoreElement.textContent = this.localSnake?.score || 0;
                    } else {
                        const player = this.otherPlayers.get(playerId);
                        scoreElement.textContent = player?.score || 0;
                    }
                });
            }

            render() {
                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.fillStyle = 'rgba(10, 10, 15, 0.9)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // ç»˜åˆ¶ç½‘æ ¼
                this.drawGrid();

                // ç»˜åˆ¶é£Ÿç‰©
                if (this.food) {
                    this.drawFood();
                }

                // ç»˜åˆ¶æ‰€æœ‰è›‡
                this.drawSnakes();
            }

            drawGrid() {
                this.ctx.strokeStyle = 'rgba(0, 255, 136, 0.1)';
                this.ctx.lineWidth = 1;
                
                for (let i = 0; i <= this.tileCount; i++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(i * this.gridSize, 0);
                    this.ctx.lineTo(i * this.gridSize, this.canvas.height);
                    this.ctx.stroke();
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, i * this.gridSize);
                    this.ctx.lineTo(this.canvas.width, i * this.gridSize);
                    this.ctx.stroke();
                }
            }

            drawFood() {
                const x = this.food.x * this.gridSize;
                const y = this.food.y * this.gridSize;
                
                // ç»˜åˆ¶å‘å…‰çš„é£Ÿç‰©
                this.ctx.save();
                this.ctx.shadowColor = '#ff6b9d';
                this.ctx.shadowBlur = 20;
                
                const gradient = this.ctx.createRadialGradient(
                    x + this.gridSize/2, y + this.gridSize/2, 0,
                    x + this.gridSize/2, y + this.gridSize/2, this.gridSize/2
                );
                gradient.addColorStop(0, '#ff6b9d');
                gradient.addColorStop(1, '#ff3d71');
                
                this.ctx.fillStyle = gradient;
                this.ctx.beginPath();
                this.ctx.arc(x + this.gridSize/2, y + this.gridSize/2, this.gridSize/3, 0, 2 * Math.PI);
                this.ctx.fill();
                
                this.ctx.restore();
            }

            drawSnakes() {
                const colors = ['#00ff88', '#ff6b9d', '#4fc3f7', '#ffd93d'];
                let colorIndex = 0;

                // ç»˜åˆ¶æœ¬åœ°è›‡
                if (this.localSnake) {
                    this.drawSnake(this.localSnake, colors[0], true);
                    colorIndex++;
                }

                // ç»˜åˆ¶å…¶ä»–ç©å®¶çš„è›‡
                this.otherPlayers.forEach(player => {
                    this.drawSnake(player, colors[colorIndex % colors.length], false);
                    colorIndex++;
                });
            }

            drawSnake(snake, color, isLocal) {
                if (!snake.body || snake.body.length === 0) return;

                this.ctx.save();
                
                // å¦‚æœæ˜¯æœ¬åœ°ç©å®¶ï¼Œæ·»åŠ é¢å¤–å‘å…‰æ•ˆæœ
                if (isLocal) {
                    this.ctx.shadowColor = color;
                    this.ctx.shadowBlur = 15;
                }

                snake.body.forEach((segment, index) => {
                    const x = segment.x * this.gridSize;
                    const y = segment.y * this.gridSize;
                    
                    // å¤´éƒ¨ç‰¹æ®Šæ¸²æŸ“
                    if (index === 0) {
                        const gradient = this.ctx.createRadialGradient(
                            x + this.gridSize/2, y + this.gridSize/2, 0,
                            x + this.gridSize/2, y + this.gridSize/2, this.gridSize/2
                        );
                        gradient.addColorStop(0, '#ffffff');
                        gradient.addColorStop(0.7, color);
                        gradient.addColorStop(1, this.darkenColor(color, 0.3));
                        
                        this.ctx.fillStyle = gradient;
                        this.ctx.fillRect(x + 2, y + 2, this.gridSize - 4, this.gridSize - 4);
                        
                        // çœ¼ç›
                        this.ctx.fillStyle = '#000000';
                        this.ctx.fillRect(x + 6, y + 6, 3, 3);
                        this.ctx.fillRect(x + this.gridSize - 9, y + 6, 3, 3);
                    } else {
                        // èº«ä½“æ¸å˜æ•ˆæœ
                        const alpha = 1 - (index * 0.05);
                        const bodyColor = this.hexToRgba(color, Math.max(alpha, 0.3));
                        
                        this.ctx.fillStyle = bodyColor;
                        this.ctx.fillRect(x + 1, y + 1, this.gridSize - 2, this.gridSize - 2);
                    }
                });
                
                this.ctx.restore();
            }

            darkenColor(color, amount) {
                const num = parseInt(color.slice(1), 16);
                const amt = Math.round(255 * amount);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            }

            hexToRgba(hex, alpha) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? 
                    `rgba(${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}, ${alpha})` : 
                    hex;
            }

            updateGameTime() {
                if (this.gameStartTime) {
                    const elapsed = Date.now() - this.gameStartTime;
                    const minutes = Math.floor(elapsed / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    document.getElementById('gameTime').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }

            eliminatePlayer(data) {
                this.showNotification(`${data.playerName} è¢«æ·˜æ±°äº†ï¼`, 'warning');
                
                if (data.playerId === this.playerInfo.id) {
                    this.gameState = 'eliminated';
                    this.showNotification('ä½ è¢«æ·˜æ±°äº†ï¼ç»§ç»­è§‚çœ‹å…¶ä»–ç©å®¶æ¯”èµ›', 'error');
                }
            }

            finishGame(data) {
                this.gameState = 'finished';
                this.showGameFinished(data);
            }

            showGameFinished(data) {
                const overlay = this.gameFinishedOverlay;
                const title = document.getElementById('finishTitle');
                const message = document.getElementById('finishMessage');
                const leaderboard = document.getElementById('finalLeaderboard');

                // è®¾ç½®æ ‡é¢˜å’Œæ¶ˆæ¯
                if (data.winner && data.winner.id === this.playerInfo.id) {
                    title.textContent = 'ğŸ† æ­å–œè·èƒœï¼';
                    title.style.color = '#ffd700';
                    message.textContent = `ä½ ä»¥ ${data.winner.score} åˆ†çš„æˆç»©è·å¾—ç¬¬ä¸€åï¼`;
                } else {
                    title.textContent = 'ğŸ æ¸¸æˆç»“æŸ';
                    message.textContent = data.winner ? 
                        `${data.winner.username} è·å¾—èƒœåˆ©ï¼` : 
                        'æ¸¸æˆå·²ç»“æŸ';
                }

                // ç”Ÿæˆæ’è¡Œæ¦œ
                leaderboard.innerHTML = '';
                data.finalRanking.forEach((player, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    
                    const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
                    const rankIcon = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}`;
                    
                    item.innerHTML = `
                        <span class="rank ${rankClass}">${rankIcon}</span>
                        <span>${player.username}${player.id === this.playerInfo.id ? ' (æˆ‘)' : ''}</span>
                        <span>${player.score}åˆ†</span>
                    `;
                    
                    leaderboard.appendChild(item);
                });

                overlay.classList.add('show');
            }

            showGameArea() {
                this.waitingScreen.classList.add('hidden');
                this.canvasContainer.classList.remove('hidden');
            }

            hideGameArea() {
                this.waitingScreen.classList.remove('hidden');
                this.canvasContainer.classList.add('hidden');
                this.gameFinishedOverlay.classList.remove('show');
            }

            showNotification(message, type = 'info') {
                console.log(`[${type.toUpperCase()}] ${message}`);
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¥½çš„é€šçŸ¥UI
            }
        }

        // å…¨å±€å˜é‡
        let game;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            game = new MultiplayerSnakeGame();
        });

        // å…¨å±€å‡½æ•°
        function joinRandomRoom() {
            if (!game.connected) {
                game.showNotification('è¯·ç­‰å¾…è¿æ¥åˆ°æœåŠ¡å™¨', 'error');
                return;
            }

            document.getElementById('loadingSpinner').classList.remove('hidden');
            game.socket.emit('join_snake_room', { gameType: 'speed_race' });
        }

        function toggleReady() {
            if (!game.roomInfo) return;
            
            const myPlayer = game.roomInfo.players.find(p => p.id === game.playerInfo?.id);
            const newReadyState = !myPlayer?.ready;
            
            game.socket.emit('toggle_ready', { ready: newReadyState });
        }

        function leaveRoom() {
            if (!game.roomInfo) return;
            
            game.socket.emit('leave_room');
            game.roomInfo = null;
            game.playerInfo = null;
            game.gameState = 'waiting';
            
            game.hideGameArea();
            game.updateRoomDisplay();
            game.updateButtonStates();
            
            document.getElementById('loadingSpinner').classList.add('hidden');
        }
    </script>
</body>
</html>

